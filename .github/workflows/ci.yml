name: Préparation de l'environnement back-end

on:
    push:
      branches:
        - main
        - develop
    pull_request:
      branches:
        - main
        - develop

jobs:
  dev:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      # Cette action clone le dépôt Git dans la machine virtuelle Ubuntu pour que les fichiers soient disponibles pour les étapes suivantes
      - uses: actions/checkout@v4
      - name: echo de test
        run: echo "Workflow exécuté suite à un push ou une pull request sur la branche develop."
      - name: Contruction de l'image docker
        run: |
          docker build . -t aurorereynier/recipies-sharing-back:v1.0

      - name: push de l'image odcker du VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          docker save my-app-dev | ssh -i ~/.ssh/id_rsa -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "docker load"


  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      # Cette action clone le dépôt Git dans la machine virtuelle Ubuntu pour que les fichiers soient disponibles pour les étapes suivantes
      - uses: actions/checkout@v4
      - name: echo de test
        run: echo "Workflow exécuté suite à un push ou une pull request sur la branche main."